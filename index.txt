<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•©ê²©ë© í¼í™íŠ¸ ê´€ì œ ì‹œìŠ¤í…œ (v12)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --seat-red: #ff6b6b;       /* ê²°ì„ (ê¸°ë³¸) */
            --seat-green: #51cf66;     /* ì¶œì„ */
            --seat-black: #212529;     /* ê³ ì •ì„ */
            --seat-gray: #adb5bd;      /* X ì¢Œì„ */
            --seat-exempt: #e9ecef;    /* ì…ì‹¤ ì•ˆí•¨ (ë©´ì œ) */
            --seat-exempt-text: #adb5bd;
            --bg-color: #f8f9fa;
            --sidebar-width: 400px;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* ì‹œì‘ ì˜¤ë²„ë ˆì´ */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            color: white; cursor: pointer; text-align: center;
        }
        #start-overlay h1 { font-size: 3rem; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #start-overlay p { font-size: 1.5rem; animation: pulse 1.5s infinite; color: #ffd43b; font-weight: bold; }

        header {
            background: white; padding: 10px 20px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; height: 70px; box-sizing: border-box;
        }
        .header-logo img { height: 50px; }
        .header-clock { font-size: 1.4rem; font-weight: bold; color: #333; background: #f1f3f5; padding: 5px 20px; border-radius: 20px; }

        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        .seat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .sidebar { width: var(--sidebar-width); background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
        .sidebar-header { padding: 15px; background: #343a40; color: white; font-weight: bold; text-align: center; font-size: 1.1rem; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }

        .status-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .status-table th { background: #f1f3f5; padding: 8px; border-bottom: 2px solid #ddd; color: #495057; position: sticky; top: 0; }
        .status-table td { padding: 8px 4px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        
        .badge-late { background: #ff6b6b; color: white; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; display: inline-block; margin-bottom: 4px;}
        .badge-penalty-text { color: #c92a2a; font-weight: 900; font-size: 14px; animation: pulse 1s infinite; display: inline-block; margin-right: 5px;}
        
        .action-btn { border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; margin: 1px; color: white; }
        .btn-attend { background-color: #51cf66; } .btn-attend:hover { background-color: #40c057; }
        .btn-penalty { background-color: #fa5252; } .btn-penalty:hover { background-color: #e03131; }
        .btn-check { background-color: #adb5bd; } .btn-check:hover { background-color: #868e96; }
        .btn-check.done { background-color: #228be6; cursor: default; }

        .grid-container { display: grid; gap: 6px; justify-content: center; margin-bottom: 30px; padding: 15px; background-color: #e9ecef; border-radius: 10px; }
        #premium-grid { grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(5, 70px); }
        #study-grid { grid-template-columns: repeat(10, 80px); grid-template-rows: repeat(16, 60px); }

        .seat {
            background-color: var(--seat-red); color: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 5px; font-weight: bold; font-size: 14px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.1s; position: relative;
        }
        .seat:hover { transform: scale(1.05); z-index: 10; }
        .seat.green { background-color: var(--seat-green); }
        .seat.black { background-color: var(--seat-black); color: #868e96; cursor: not-allowed; }
        .seat.gray-x { background-color: var(--seat-gray); color: #eee; }
        .seat.exempt { background-color: var(--seat-exempt); color: var(--seat-exempt-text); border: 2px dashed #ced4da; box-shadow: none; }
        .time-badge { font-size: 10px; background: rgba(0,0,0,0.3); padding: 1px 5px; border-radius: 10px; margin-top: 3px; font-weight: normal; }

        @keyframes seat-flash {
            0% { background-color: var(--seat-red); box-shadow: 0 0 0 red; transform: scale(1); }
            50% { background-color: #ff9999; box-shadow: 0 0 15px red; transform: scale(1.02); }
            100% { background-color: var(--seat-red); box-shadow: 0 0 0 red; transform: scale(1); }
        }
        .seat.flashing { animation: seat-flash 0.5s infinite !important; border: 2px solid red !important; z-index: 20; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .controls { padding: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;}
        .btn-ctrl { padding: 10px 20px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 30px; border: none; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn-ctrl:active { transform: scale(0.95); }
        .reset-btn { background-color: var(--seat-green); } .reset-btn:hover { background-color: #40c057; }
        .backup-btn { background-color: #228be6; } .backup-btn:hover { background-color: #1c7ed6; }
        .restore-btn { background-color: #fd7e14; } .restore-btn:hover { background-color: #f76707; }

        .context-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); border-radius: 5px; z-index: 2000; width: 160px; }
        .context-menu li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f3f5; list-style: none; font-size: 14px; }
        .context-menu li:hover { background-color: #e7f5ff; }

        /* ================= ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ================= */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2999; }
        #schedule-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 1200px; max-height: 95vh; overflow-y: auto; z-index: 3000; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .modal-header h2 { margin: 0; font-size: 24px; color: #333; }
        .preset-area { display: flex; gap: 10px; }
        .btn-preset { padding: 8px 16px; font-size: 13px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; color: white; transition: opacity 0.2s; }
        .btn-preset:hover { opacity: 0.8; }
        .btn-high { background-color: #7048e8; }
        .btn-nsu { background-color: #1098ad; }

        /* í•™ìƒ ì •ë³´ ì…ë ¥ ì˜ì—­ */
        .info-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; 
            background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #eee;
        }
        .info-group { display: flex; flex-direction: column; }
        .info-group label { font-size: 12px; color: #666; margin-bottom: 4px; font-weight: bold; }
        .info-group input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; text-align: center; width: 100%; box-sizing: border-box; }
        
        /* ì‹œê°„í‘œ ìŠ¤íƒ€ì¼ ìˆ˜ì • (ìš”ì²­ì‚¬í•­ ë°˜ì˜) */
        .schedule-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 13px; margin-bottom: 20px;}
        .schedule-table th, .schedule-table td { border: 1px solid #dee2e6; padding: 4px; vertical-align: top;}
        
        /* [ìˆ˜ì •] 1ì—´(êµì‹œ) ë„ˆë¹„ ë° í°íŠ¸ í™•ì¥ */
        .schedule-table th:first-child, .schedule-table td:first-child {
            width: 140px; 
            min-width: 140px;
            font-size: 15px; 
            font-weight: bold;
            background-color: #f1f3f5;
            vertical-align: middle;
        }
        
        .schedule-table th { background: #f8f9fa; position: sticky; top: 0; padding: 10px;}
        .schedule-table input[type="time"] { width: 100%; border: 1px solid #ddd; padding: 4px; text-align: center; box-sizing: border-box; cursor: pointer; margin-bottom: 4px;}
        .input-basic { background-color: #d3f9d8 !important; border: 1px solid #b2f2bb !important; font-weight: bold; color: #0b7285;}
        .input-custom { background-color: #ffe8cc !important; border: 1px solid #ffc078 !important; font-weight: bold; color: #d9480f;}
        .btn-toggle-exempt { display: block; width: 100%; padding: 3px; font-size: 11px; cursor: pointer; border-radius: 3px; border: 1px solid #ccc; background-color: #f8f9fa; color: #666; }
        .btn-toggle-exempt.active { background-color: #495057; color: #fff; border-color: #343a40; }
        
        .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
        .modal-logo { height: 40px; opacity: 0.7; }
        .btn { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-save { background: #228be6; color: white; } .btn-cancel { background: #e9ecef; color: #495057; }
        .btn-print { background: #343a40; color: white; margin-right: 10px; }
        .btn-img { background: #12b886; color: white; margin-right: 10px; }

        /* --- ìº¡ì²˜/ì¸ì‡„ ëª¨ë“œ ìŠ¤íƒ€ì¼ (ì˜ë¦¼ ë°©ì§€ ë° ìŠ¤íƒ€ì¼ ìµœì í™”) --- */
        .capture-mode #schedule-modal {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 1200px !important; /* ê°•ì œ ë„“ì´ ì§€ì • */
            height: auto !important; max-height: none !important;
            overflow: visible !important; border-radius: 0 !important; box-shadow: none !important; padding: 40px !important;
            background: white !important; z-index: 10000 !important;
            transform: none !important; margin: 0 !important;
        }
        
        /* ìº¡ì²˜ ì‹œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¹€ */
        .capture-mode .modal-actions, .capture-mode .preset-area, .capture-mode .btn-toggle-exempt, .capture-mode p { display: none !important; }
        
        /* ìº¡ì²˜ ì‹œ ì¸í’‹ ë°•ìŠ¤ë¥¼ í…ìŠ¤íŠ¸ì²˜ëŸ¼ ë³´ì´ê²Œ */
        .capture-mode .info-grid { border: 2px solid #333; background: white; }
        .capture-mode .info-group input { border: none !important; background: transparent !important; font-weight: bold; font-size: 16px; padding: 0; }
        .capture-mode .schedule-table th, .capture-mode .schedule-table td { border: 1px solid #000 !important; padding: 8px !important; }
        
        .print-text-span { display: block; font-weight: bold; font-size: 14px; padding: 10px 0; }
        
        /* ì¸ì‡„ ìƒ‰ìƒ: ì‹¬í”Œ ëª¨ë“œ */
        .capture-mode .cell-green { background-color: #51cf66 !important; color: transparent !important; } 
        .capture-mode .cell-green-text { background-color: #51cf66 !important; color: black !important; } 
        .capture-mode .cell-red { background-color: #ff6b6b !important; color: white !important; } 

        /* ì¸ì‡„ ì‹œ í—¤ë” ë“± ìˆ¨ê¹€ */
        @media print {
            body > * { visibility: hidden; }
            #schedule-modal, #schedule-modal * { visibility: visible; }
            #schedule-modal { 
                position: absolute; left: 0; top: 0; width: 100%; height: auto; overflow: visible; 
            }
        }
        #file-input { display: none; }
    </style>
</head>
<body>
    
    <div id="start-overlay" onclick="startSystem()">
        <h1>ğŸ–±ï¸ í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”!</h1>
        <p>í•©ê²©ë© ê´€ì œ ì‹œìŠ¤í…œ ì‹œì‘í•˜ê¸°</p>
    </div>

    <header>
        <div class="header-logo">
            <img src="logo.png" alt="í•©ê²©LAB ë¼ì´ë¸ŒëŸ¬ë¦¬" onerror="this.style.display='none'; this.parentElement.innerText='í•©ê²©LAB ë¼ì´ë¸ŒëŸ¬ë¦¬';">
        </div>
        <div class="header-clock" id="current-clock">00:00:00 (ì›”)</div>
    </header>
    <div class="main-wrapper">
        <div class="seat-area">
            <h2>í”„ë¦¬ë¯¸ì—„ ì¡´</h2><div id="premium-grid" class="grid-container"></div>
            <h2>ìŠ¤í„°ë”” ì¡´</h2><div id="study-grid" class="grid-container"></div>
            <div class="controls">
                <button class="btn-ctrl reset-btn" onclick="resetGreenSeats()">ğŸ”„ í‡´ì‹¤ ì²˜ë¦¬</button>
                <button class="btn-ctrl backup-btn" onclick="downloadBackup()">ğŸ’¾ ë°ì´í„° ë°±ì—…</button>
                <button class="btn-ctrl restore-btn" onclick="triggerRestore()">ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="file-input" accept=".txt, .json" onchange="loadBackup(this)">
            </div>
            <div style="font-size:12px; color:#888; margin-bottom: 20px;">
                ğŸ’¡ <b>ì•ˆë‚´:</b> ì¸ì‡„ ì‹œ ìë™ìœ¼ë¡œ í¬ë§·ì´ ë³€í™˜ë˜ì–´ ê¸€ìê°€ ì˜ë¦¬ì§€ ì•Šê³  ê¹”ë”í•˜ê²Œ ì¶œë ¥ë©ë‹ˆë‹¤.
            </div>
        </div>
        <div class="sidebar">
            <div class="sidebar-header">ğŸš¨ ì‹¤ì‹œê°„ ì§€ê° ê´€ì œ</div>
            <div class="sidebar-content">
                <table class="status-table">
                    <thead><tr><th style="width: 25%">ì´ë¦„</th><th style="width: 25%">ì¶œì„í˜„í™©</th><th style="width: 50%">ì²˜ë¦¬í˜„í™©</th></tr></thead>
                    <tbody id="status-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <audio id="alarm-sound" src="í•©ê²©ë© ì¢…ì†Œë¦¬.MP3" loop></audio>

    <ul id="seat-context-menu" class="context-menu">
        <li onclick="seatMenuAction('schedule')">ğŸ“‹ ê°œì¸ ì‹œê°„í‘œ ë° ì •ë³´ ì„¤ì •</li>
        <li onclick="seatMenuAction('editName')">âœï¸ ì´ë¦„ë§Œ ë¹ ë¥´ê²Œ ë³€ê²½</li>
        <li onclick="seatMenuAction('toggleBlack')">ğŸ”’ ê³ ì •ì„(ê²€ì •) ì„¤ì •/í•´ì œ</li>
    </ul>

    <div id="modal-overlay"></div>
    <div id="schedule-modal">
        <div class="modal-header">
            <h2>í•©ê²©ë© ê°œì¸ì‹œê°„í‘œ</h2>
            <div class="preset-area">
                <button class="btn-preset btn-high" onclick="applyPresetHighSchool()">ğŸ« ê³ ë“±ë°˜</button>
                <button class="btn-preset btn-nsu" onclick="applyPresetNSu()">ğŸ“š Nìˆ˜/ì„±ì¸ë°˜</button>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-group">
                <label>ì´ë¦„</label>
                <input type="text" id="info-name" placeholder="ì´ë¦„ ì…ë ¥">
            </div>
            <div class="info-group">
                <label>ì´ìš©ê¸°ê°„</label>
                <input type="text" id="info-period" placeholder="ì˜ˆ: ~12/31">
            </div>
            <div class="info-group">
                <label>ì¢Œì„ ë²ˆí˜¸</label>
                <input type="text" id="info-seat" placeholder="ë²ˆí˜¸ ì…ë ¥">
            </div>
            <div class="info-group">
                <label>ì‚¬ë¬¼í•¨ ë²ˆí˜¸</label>
                <input type="text" id="info-locker" placeholder="ë²ˆí˜¸ ì…ë ¥">
            </div>
            <div class="info-group">
                <label>í°ë³´ê´€í•¨ ë²ˆí˜¸</label>
                <input type="text" id="info-phone" placeholder="ë²ˆí˜¸ ì…ë ¥">
            </div>
        </div>

        <p style="text-align:center; font-size:12px; color:#666; margin-top:0;">
            ë¹ˆì¹¸: ê¸°ë³¸ì‹œê°„ ì ìš© | ë”ë¸”í´ë¦­: ê¸°ë³¸ê°’ ì…ë ¥ | ë²„íŠ¼: <b>[ì…ì‹¤ì•ˆí•¨]</b> ì„¤ì •
        </p>
        <table class="schedule-table">
            <thead><tr><th>êµì‹œ</th><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr></thead>
            <tbody id="schedule-tbody"></tbody>
        </table>

        <div class="modal-footer">
            <img src="logo.png" alt="í•©ê²©LAB" class="modal-logo" onerror="this.style.display='none'">
            <div class="modal-actions">
                <button class="btn btn-img" onclick="saveAsImage()">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
                <button class="btn btn-print" onclick="printSchedule()">ğŸ–¨ï¸ ì¸ì‡„</button>
                <button class="btn btn-save" onclick="saveSchedule()">ì €ì¥ ë° ë‹«ê¸°</button>
                <button class="btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        // [ìˆ˜ì •] 1êµì‹œ ì‹œê°„ ë³€ê²½
        const PERIODS = [
            { name: "1êµì‹œ", start: "08:00", end: "09:10" }, 
            { name: "2êµì‹œ", start: "09:20", end: "10:40" },
            { name: "3êµì‹œ", start: "10:50", end: "12:00" }, 
            { name: "4êµì‹œ", start: "13:10", end: "14:40" },
            { name: "5êµì‹œ", start: "14:50", end: "16:20" }, 
            { name: "6êµì‹œ", start: "16:30", end: "18:00" },
            { name: "7êµì‹œ", start: "19:10", end: "20:40" }, 
            { name: "8êµì‹œ", start: "20:50", end: "22:20" },
            { name: "9êµì‹œ", start: "22:30", end: "24:00" }
        ];

        let seatsData = {}; let selectedSeatId = null; let lastResetTime = ""; 
        let isAlarmPlaying = false;

        window.onload = function() {
            loadData(); renderSeats(); 
            document.addEventListener('click', () => {
                document.getElementById('seat-context-menu').style.display = 'none';
            });
        };

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            checkPeriodOnLoad(); 
            setInterval(gameLoop, 1000); 
            document.body.addEventListener('click', stopAlarm);
        }

        function loadData() {
            const v8 = localStorage.getItem('studyRoom_v8_final');
            if (v8) {
                seatsData = JSON.parse(v8);
            } else {
                const v7 = localStorage.getItem('studyRoom_v7_final');
                if (v7) {
                    seatsData = JSON.parse(v7);
                    for (const id in seatsData) { if (!seatsData[id].info) seatsData[id].info = { period: '', locker: '', phone: '' }; }
                    saveData();
                } else {
                    const v6 = localStorage.getItem('studyRoom_v6_x_default');
                    if(v6) {
                        seatsData = JSON.parse(v6);
                        for (const id in seatsData) {
                            if (!seatsData[id].exemptGrid) seatsData[id].exemptGrid = {};
                            if (!seatsData[id].info) seatsData[id].info = { period: '', locker: '', phone: '' };
                        }
                        saveData();
                    } else {
                        initData('P', 15); initData('S', 160);
                    }
                }
            }
        }
        function saveData() { localStorage.setItem('studyRoom_v8_final', JSON.stringify(seatsData)); }
        function initData(prefix, count) {
            for (let i = 1; i <= count; i++) {
                const id = `${prefix}-${i}`;
                if (!seatsData[id]) { 
                    seatsData[id] = { 
                        id: id, name: 'X', state: 0, 
                        scheduleGrid: {}, scheduleV3: {}, penaltyInfo: null, exemptGrid: {},
                        info: { period: '', locker: '', phone: '' } 
                    }; 
                }
            }
        }

        function checkPeriodOnLoad() {
            const now = new Date();
            const currentHM = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            const todayIdx = now.getDay();
            let currentPeriodIdx = -1;
            PERIODS.forEach((p, idx) => { if (currentHM >= p.start) currentPeriodIdx = idx; });
            const storedLastPeriod = localStorage.getItem('last_active_period');
            
            if (currentPeriodIdx !== -1 && String(currentPeriodIdx) !== storedLastPeriod) {
                checkAndResetSeats(PERIODS[currentPeriodIdx].start, todayIdx, true); 
                localStorage.setItem('last_active_period', currentPeriodIdx);
                playAlarm();
            } else { updateSidebarList(); }
        }

        function playAlarm() {
            const audio = document.getElementById('alarm-sound');
            if (!isAlarmPlaying) {
                audio.currentTime = 0;
                audio.play().then(() => { isAlarmPlaying = true; }).catch(e => console.log(e));
            }
        }
        function stopAlarm() {
            const audio = document.getElementById('alarm-sound');
            if (isAlarmPlaying) { audio.pause(); isAlarmPlaying = false; }
        }

        function renderSeats() { drawGrid('premium-grid', 'P', 15); drawGrid('study-grid', 'S', 160); refreshVisuals(); }
        function drawGrid(gridId, prefix, count) {
            const container = document.getElementById(gridId); container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const id = `${prefix}-${i}`; const div = document.createElement('div');
                div.className = 'seat'; div.id = id;
                div.onclick = () => toggleSeat(id); div.oncontextmenu = (e) => showSeatMenu(e, id);
                div.innerHTML = `<span class="seat-name"></span><span class="time-badge"></span>`;
                container.appendChild(div);
            }
        }
        function refreshVisuals() {
            const now = new Date(); const today = now.getDay();
            for (const id in seatsData) {
                const data = seatsData[id]; const el = document.getElementById(id);
                if (!el) continue;
                el.querySelector('.seat-name').textContent = data.name;
                const todayTimes = (data.scheduleV3 && data.scheduleV3[today]) ? data.scheduleV3[today] : [];
                const badge = el.querySelector('.time-badge');
                const configuredCount = todayTimes.length > 0 ? todayTimes.length : 0;
                badge.style.display = configuredCount > 0 ? 'block' : 'none';
                badge.textContent = configuredCount > 0 ? `${configuredCount}êµì‹œ ì„¤ì •` : '';
                el.classList.remove('green', 'black', 'gray-x', 'exempt');
                if (data.state === 3) el.classList.add('black'); 
                else if (data.state === 1) el.classList.add('green'); 
                else if (data.state === 4) el.classList.add('exempt'); 
                else if (data.name === 'X') el.classList.add('gray-x'); 
            }
        }
        function toggleSeat(id) {
            const data = seatsData[id]; if (data.state === 3) return;
            if (data.state === 1) { data.state = 0; } else { data.state = 1; data.penaltyInfo = null; }
            saveData(); refreshVisuals(); updateSidebarList();
        }
        function gameLoop() {
            const now = new Date();
            const currentHM = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            const todayIdx = now.getDay();
            document.getElementById('current-clock').textContent = `${now.toLocaleTimeString('ko-KR', { hour12: false })} (${DAYS[todayIdx]})`;
            if (currentHM !== lastResetTime) {
                lastResetTime = currentHM;
                PERIODS.forEach((p, idx) => { if (p.start === currentHM) localStorage.setItem('last_active_period', idx); });
                checkAndResetSeats(currentHM, todayIdx, false);
            }
            updateSidebarList();
        }
        function checkAndResetSeats(time, dayIdx, forceReset) {
            let changed = false; let triggerAlarm = false;
            for (const id in seatsData) {
                const data = seatsData[id];
                if (data.state === 3 || data.name === 'X') continue;
                let targetTime = null; let periodIdx = -1;
                for(let p=0; p<9; p++) {
                    const key = `${dayIdx}-${p}`;
                    let scheduledTime = PERIODS[p].start;
                    if (data.scheduleGrid && data.scheduleGrid[key]) scheduledTime = data.scheduleGrid[key];
                    if (scheduledTime === time) { targetTime = scheduledTime; periodIdx = p; break; }
                }
                if (targetTime) {
                    const exemptKey = `${dayIdx}-${periodIdx}`;
                    const isExempt = data.exemptGrid && data.exemptGrid[exemptKey];
                    if (isExempt) { data.state = 4; } 
                    else { data.state = 0; triggerAlarm = true; }
                    data.penaltyInfo = null; changed = true;
                }
            }
            if (changed) { 
                saveData(); refreshVisuals(); updateSidebarList();
                if (triggerAlarm && !forceReset) playAlarm(); 
            }
        }
        function updateSidebarList() {
            const tbody = document.getElementById('status-tbody'); let html = '';
            const now = new Date(); const todayIdx = now.getDay();
            const currentHM = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            for (const id in seatsData) {
                const data = seatsData[id]; const el = document.getElementById(id);
                if (el) el.classList.remove('flashing'); 
                if (data.state === 3 || data.state === 1 || data.state === 4 || data.name === 'X') continue;
                let latestMissedTime = null;
                for(let p=0; p<9; p++) {
                    const key = `${todayIdx}-${p}`;
                    const time = data.scheduleGrid && data.scheduleGrid[key] ? data.scheduleGrid[key] : PERIODS[p].start;
                    if (currentHM >= time) {
                        const isExempt = data.exemptGrid ? data.exemptGrid[key] : false;
                        if (!isExempt) { if (!latestMissedTime || time > latestMissedTime) latestMissedTime = time; }
                    }
                }
                if (latestMissedTime) {
                    const hasPenalty = data.penaltyInfo && data.penaltyInfo.type === 'penalty';
                    const isRecorded = data.penaltyInfo && data.penaltyInfo.recorded;
                    const isNoticed = data.penaltyInfo && data.penaltyInfo.noticed;
                    if (isRecorded && isNoticed) continue;
                    if (!hasPenalty && el) el.classList.add('flashing');
                    let statusHtml = `<span class="badge-late">ì§€ê°</span> <span style="font-size:11px; color:#888;">(${latestMissedTime})</span>`;
                    let actionHtml = `<button class="action-btn btn-attend" onclick="processAttend('${id}')">ì¶œì„</button><button class="action-btn btn-penalty" onclick="processPenalty('${id}')">ë²Œì </button>`;
                    let rowStyle = '';
                    if (hasPenalty) {
                        rowStyle = 'background-color: #fff5f5;';
                        let recordClass = isRecorded ? 'action-btn btn-check done' : 'action-btn btn-check';
                        let noticeClass = isNoticed ? 'action-btn btn-check done' : 'action-btn btn-check';
                        actionHtml = `<span class="badge-penalty-text">ë²Œì </span><button class="${recordClass}" onclick="toggleRecord('${id}')">ê¸°ë¡</button><button class="${noticeClass}" onclick="toggleNotice('${id}')">ê³ ì§€</button>`;
                    }
                    html += `<tr style="${rowStyle}"><td><b>${data.name}</b></td><td>${hasPenalty ? '-' : statusHtml}</td><td>${actionHtml}</td></tr>`;
                }
            }
            tbody.innerHTML = html === '' ? '<tr><td colspan="3" style="padding:20px; color:#999;">ì§€ê°ìƒì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‰</td></tr>' : html;
        }

        // --- ì´ë¯¸ì§€ ì €ì¥ & ì¸ì‡„ ì¤€ë¹„ ---
        function prepareForPrintOrSave() {
            const rows = document.getElementById('schedule-tbody').rows;
            for(let r=0; r<rows.length; r++) {
                const cells = rows[r].cells;
                // ì²«ë²ˆì§¸ ì»¬ëŸ¼(êµì‹œ)ì— í…ìŠ¤íŠ¸ ë„£ê¸°
                cells[0].innerText = `${PERIODS[r].name}\n${PERIODS[r].start}~${PERIODS[r].end}`;
                
                for(let c=1; c<cells.length; c++) {
                    const cell = cells[c];
                    const input = cell.querySelector('input');
                    const btn = cell.querySelector('button');
                    const defaultTime = PERIODS[r].start;
                    cell.className = '';
                    const span = document.createElement('span');
                    span.className = 'print-text-span';
                    
                    if (btn.dataset.exempt === 'true') {
                        cell.classList.add('cell-red');
                        span.textContent = "ì…ì‹¤ì•ˆí•¨";
                        span.style.color = "white";
                    } else {
                        if (input.value && input.value !== defaultTime) {
                            cell.classList.add('cell-green-text');
                            span.textContent = input.value + " ì…ì‹¤";
                        } else {
                            cell.classList.add('cell-green');
                            span.textContent = ""; 
                        }
                    }
                    input.style.display = 'none';
                    cell.appendChild(span);
                }
            }
            document.body.classList.add('capture-mode');
            
            // ìº¡ì²˜ ëª¨ë“œì—ì„œ ë¡œê³  ë° í•˜ë‹¨ ì—¬ë°± í™•ë³´ë¥¼ ìœ„í•´ ëª¨ë‹¬ í¬ê¸° ê°•ì œ ì¡°ì •
            const modal = document.getElementById('schedule-modal');
            modal.style.width = "1200px";
        }

        function cleanupAfterPrintOrSave() {
            document.body.classList.remove('capture-mode');
            const spans = document.querySelectorAll('.print-text-span');
            spans.forEach(span => span.remove());
            const inputs = document.querySelectorAll('#schedule-tbody input');
            inputs.forEach(input => input.style.display = '');
            const rows = document.getElementById('schedule-tbody').rows;
            for(let r=0; r<rows.length; r++) {
                const cells = rows[r].cells;
                cells[0].innerText = ""; // êµì‹œ í…ìŠ¤íŠ¸ ë³µêµ¬ (ê¸°ì¡´ì—” CSSê°€ ì•„ë‹˜) -> ì•„ë‹ˆ, ê¸°ì¡´ì—” TDì˜€ìŒ. 
                // ê¸°ì¡´ì—” TD ì•ˆì— ì•„ë¬´ê²ƒë„ ì—†ì—ˆë‚˜? ì•„ë‹˜.
                // ì•„ ì›ë˜ PERIODS ë£¨í”„ì—ì„œ innerHTMLë¡œ ë„£ì—ˆì—ˆìŒ. ë³µêµ¬ í•„ìš”.
            }
            // í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ê°„í¸ ë³µêµ¬)
            openScheduleModal(selectedSeatId);
        }

        function saveAsImage() {
            prepareForPrintOrSave();
            const modalContent = document.querySelector("#schedule-modal");
            // html2canvas ì˜µì…˜: í™”ë©´ ë°– ìš”ì†Œë„ ìº¡ì²˜
            html2canvas(modalContent, {
                scale: 2, // ê³ í•´ìƒë„
                useCORS: true,
                windowWidth: 1400, // ê°€ìƒ í™”ë©´ ë„ˆë¹„
            }).then(canvas => {
                const link = document.createElement("a");
                document.body.appendChild(link);
                link.download = `ì‹œê°„í‘œ_${document.getElementById('info-name').value}.png`;
                link.href = canvas.toDataURL();
                link.target = '_blank';
                link.click();
                document.body.removeChild(link);
                cleanupAfterPrintOrSave();
            });
        }

        function printSchedule() {
            prepareForPrintOrSave();
            window.print();
            setTimeout(() => { cleanupAfterPrintOrSave(); }, 1000);
        }

        // --- í”„ë¦¬ì…‹ & ê¸°íƒ€ ---
        function applyPresetHighSchool() {
            if (!confirm("ê³ ë“±ë°˜ í”„ë¦¬ì…‹ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            applyPresetLogic((dayIdx, periodIdx) => (dayIdx >= 1 && dayIdx <= 5 && periodIdx <= 5));
        }
        function applyPresetNSu() {
            if (!confirm("Nìˆ˜/ì„±ì¸ë°˜ í”„ë¦¬ì…‹ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            applyPresetLogic((dayIdx, periodIdx) => (dayIdx === 0 && periodIdx >= 3) || (dayIdx >= 1 && periodIdx === 8));
        }
        function applyPresetLogic(isExemptFunc) {
            const rows = document.getElementById('schedule-tbody').rows;
            for(let r=0; r<rows.length; r++) {
                const cells = rows[r].cells;
                for(let c=1; c<cells.length; c++) {
                    const dayIdx = c - 1; const periodIdx = r;
                    const btn = cells[c].querySelector('button');
                    const input = cells[c].querySelector('input');
                    const defaultTime = PERIODS[periodIdx].start;
                    const shouldExempt = isExemptFunc(dayIdx, periodIdx);
                    if (shouldExempt) {
                        btn.classList.add('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨ ë„ê¸°'; btn.dataset.exempt = 'true';
                    } else {
                        btn.classList.remove('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨'; btn.dataset.exempt = 'false';
                        input.value = defaultTime; updateColor(input, defaultTime);
                    }
                }
            }
        }

        function openScheduleModal(id) {
            const data = seatsData[id]; const tbody = document.getElementById('schedule-tbody'); tbody.innerHTML = '';
            if(!data.scheduleGrid) data.scheduleGrid = {}; if(!data.exemptGrid) data.exemptGrid = {}; 
            
            document.getElementById('info-name').value = data.name === 'X' ? '' : data.name;
            document.getElementById('info-seat').value = data.name === 'X' ? id : data.name; 
            if(!data.info) data.info = { period: '', locker: '', phone: '' };
            document.getElementById('info-period').value = data.info.period;
            document.getElementById('info-locker').value = data.info.locker;
            document.getElementById('info-phone').value = data.info.phone;

            PERIODS.forEach((p, idx) => {
                const tr = document.createElement('tr');
                const th = document.createElement('td'); 
                // [ìˆ˜ì •] êµì‹œ ì¹¸ ë””ìì¸
                th.innerHTML = `<div style="display:flex; flex-direction:column; justify-content:center; height:100%;">
                                    <span style="font-size:16px;">${p.name}</span>
                                    <span style="font-size:13px; color:#555; margin-top:4px;">${p.start} ~ ${p.end}</span>
                                </div>`; 
                th.style.background = '#f1f3f5'; 
                tr.appendChild(th);
                for(let d=0; d<7; d++) {
                    const td = document.createElement('td'); const key = `${d}-${idx}`; 
                    const input = document.createElement('input'); input.type = 'time'; input.dataset.day = d; input.dataset.period = idx;
                    let val = data.scheduleGrid[key] || ""; input.value = val; input.placeholder = p.start;
                    if(val) updateColor(input, p.start);
                    
                    input.onfocus = function() { this.dataset.previous = this.value; };
                    input.onchange = function() {
                        const newVal = this.value; if (!newVal) { this.className = ''; return; }
                        if (newVal < p.start || newVal > p.end) { alert(`ì‹œê°„ ì˜¤ë¥˜\n(${p.name}: ${p.start} ~ ${p.end})`); this.value = this.dataset.previous; return; }
                        updateColor(this, p.start);
                    };
                    input.ondblclick = function(){ this.value = p.start; updateColor(this, p.start); };
                    const btn = document.createElement('button'); const isExempt = data.exemptGrid[key]; 
                    btn.className = isExempt ? 'btn-toggle-exempt active' : 'btn-toggle-exempt';
                    btn.textContent = isExempt ? 'ì…ì‹¤ì•ˆí•¨ ë„ê¸°' : 'ì…ì‹¤ì•ˆí•¨';
                    btn.dataset.exempt = isExempt ? 'true' : 'false';
                    btn.onclick = function() {
                        if (this.classList.contains('active')) { 
                            this.classList.remove('active'); this.textContent = 'ì…ì‹¤ì•ˆí•¨'; this.dataset.exempt = 'false'; 
                        } else { 
                            this.classList.add('active'); this.textContent = 'ì…ì‹¤ì•ˆí•¨ ë„ê¸°'; this.dataset.exempt = 'true'; 
                        }
                    };
                    td.appendChild(input); td.appendChild(btn); tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });
            document.getElementById('modal-overlay').style.display = 'block'; document.getElementById('schedule-modal').style.display = 'block';
        }

        function saveSchedule() {
            const data = seatsData[selectedSeatId]; 
            data.scheduleGrid = {}; data.scheduleV3 = {}; data.exemptGrid = {}; 
            
            const newName = document.getElementById('info-name').value;
            if (newName && newName.trim() !== '') data.name = newName;
            data.info = {
                period: document.getElementById('info-period').value,
                locker: document.getElementById('info-locker').value,
                phone: document.getElementById('info-phone').value
            };

            const rows = document.getElementById('schedule-tbody').rows;
            for(let r=0; r<rows.length; r++) {
                const cells = rows[r].cells;
                for(let c=1; c<cells.length; c++) {
                    const dayIdx = c - 1; const periodIdx = r; const cell = cells[c];
                    const input = cell.querySelector('input'); const btn = cell.querySelector('button');
                    
                    if(input.value) { 
                        const key = `${dayIdx}-${periodIdx}`; 
                        data.scheduleGrid[key] = input.value; 
                    }
                    if (btn.dataset.exempt === 'true') { 
                        const key = `${dayIdx}-${periodIdx}`; 
                        data.exemptGrid[key] = true; 
                    }
                }
            }
            saveData(); refreshVisuals(); updateSidebarList(); closeModal();
        }

        function updateColor(el, std) { el.className = ''; if(!el.value) return; if(el.value === std) el.classList.add('input-basic'); else el.classList.add('input-custom'); }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('schedule-modal').style.display = 'none'; }
        function resetGreenSeats() {
            if (!confirm('ì¶œì„(ì´ˆë¡) ì¢Œì„ì„ ëª¨ë‘ í‡´ì‹¤ ì²˜ë¦¬í•©ë‹ˆê¹Œ?')) return;
            for (const id in seatsData) { if (seatsData[id].state === 1) seatsData[id].state = 0; }
            saveData(); refreshVisuals(); updateSidebarList();
        }
        function downloadBackup() {
            const dataStr = JSON.stringify(seatsData, null, 2); const blob = new Blob([dataStr], { type: "text/plain" });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); const date = new Date().toISOString().slice(0,10); 
            a.href = url; a.download = `í•©ê²©ë©_ë°ì´í„°ë°±ì—…_${date}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            alert("ë°ì´í„°ê°€ 'ë©”ëª¨ì¥ íŒŒì¼(.txt)'ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\në”ë¸” í´ë¦­í•´ì„œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
        function triggerRestore() { document.getElementById('file-input').click(); }
        function loadBackup(input) {
            const file = input.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (confirm("ë°±ì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.")) {
                        seatsData = loadedData; saveData(); refreshVisuals(); updateSidebarList(); alert("ë°ì´í„° ë³µêµ¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    }
                } catch (err) { alert("ì˜ëª»ëœ íŒŒì¼ì´ê±°ë‚˜ ì†ìƒëœ ë°ì´í„°ì…ë‹ˆë‹¤.\nì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼(.txt)ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); }
                input.value = ''; 
            };
            reader.readAsText(file);
        }
        function showSeatMenu(e, id) { e.preventDefault(); selectedSeatId = id; const menu = document.getElementById('seat-context-menu'); menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px'; }
        function seatMenuAction(action) {
            const data = seatsData[selectedSeatId];
            if (action === 'editName') { const newName = prompt('ì´ë¦„ ë³€ê²½:', data.name); if (newName) data.name = newName; }
            else if (action === 'toggleBlack') { data.state = (data.state === 3) ? 0 : 3; }
            else if (action === 'schedule') { openScheduleModal(selectedSeatId); }
            saveData(); refreshVisuals(); updateSidebarList();
        }
        function processAttend(id) { const data = seatsData[id]; data.state = 1; data.penaltyInfo = null; saveData(); refreshVisuals(); updateSidebarList(); }
        function processPenalty(id) { const data = seatsData[id]; data.penaltyInfo = { type: 'penalty', recorded: false, noticed: false }; saveData(); refreshVisuals(); updateSidebarList(); }
        function toggleRecord(id) { const data = seatsData[id]; if(data.penaltyInfo) { data.penaltyInfo.recorded = !data.penaltyInfo.recorded; saveData(); updateSidebarList(); } }
        function toggleNotice(id) { const data = seatsData[id]; if(data.penaltyInfo) { data.penaltyInfo.noticed = !data.penaltyInfo.noticed; saveData(); updateSidebarList(); } }
    </script>
</body>
</html>